{% extends "base.html" %}

{% block title %}Time Entry - ABC Payroll{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-clock me-2"></i>Time Entry</h1>
        <p class="text-muted">
            Pay Period: {{ start_date }} to {{ end_date }}
            {% if period and period.is_locked_bool %}
                <span class="badge bg-danger ms-2">Locked</span>
            {% else %}
                <span class="badge bg-success ms-2">Unlocked</span>
            {% endif %}
        </p>
    </div>
</div>

<!-- Employee Photo -->
{% if employee %}
<div class="text-center mb-4">
    {% if employee.has_picture and employee.picture_filename %}
    <img src="{{ url_for('static', filename='images/profile_pics/' ~ employee.picture_filename) }}"
            alt="Employee profile"
            class="img-fluid rounded-circle"
            style="width: 100%; max-width: 150px; aspect-ratio: 1/1; object-fit: cover;">
    {% else %}
    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto"
            style="width: 100%; max-width: 150px; aspect-ratio: 1/1;">
        <i class="bi bi-person-circle" style="font-size: 6rem; color: #ccc;"></i>
    </div>
    {% endif %}
    <h5 class="mt-2 mb-0">{{ employee.first_name }} {{ employee.last_name }}</h5>
    <p class="text-muted small">{{ employee.employee_id }} | PTO Balance: {{ "%.2f"|format(pto_balance) }} hrs</p>
</div>
{% endif %}

<div class="row">
    <!-- Time Entry Table -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Weekly Time Entries</h5>
            </div>
            <div class="card-body">
                {% if salary_type == 'Salary' %}
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i><strong>Salaried Employee:</strong> Automatic 8 hours Monday-Friday. Enter PTO only if needed.
                </div>
                {% endif %}

                {% if is_locked %}
                <div class="alert alert-warning">
                    <i class="bi bi-lock me-2"></i><strong>Period Locked:</strong> This pay period has been processed and cannot be edited.
                </div>
                {% endif %}

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Day</th>
                            {% if salary_type != 'Salary' %}
                            <th>Hours Worked</th>
                            {% endif %}
                            <th>PTO Hours</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                        <tr>
                            <form method="post">
                                <td>{{ entry.entry_date }}</td>
                                <td>{{ entry.day_of_week }}</td>
                                {% if salary_type != 'Salary' %}
                                <td>
                                    <input type="number" name="hours_worked" value="{{ entry.hours_worked }}"
                                           min="0" max="24" step="0.5" class="form-control form-control-sm"
                                           {% if is_locked %}disabled{% endif %}>
                                </td>
                                {% endif %}
                                <td>
                                    <input type="number" name="pto_hours" value="{{ entry.pto_hours }}"
                                           min="0" max="{{ [8, pto_balance] | min }}" step="0.5" class="form-control form-control-sm"
                                           {% if is_locked %}disabled{% endif %}>
                                </td>
                                <td>
                                    <input type="text" name="notes" value="{{ entry.notes or '' }}"
                                           class="form-control form-control-sm"
                                           {% if is_locked %}disabled{% endif %}>
                                </td>
                                <td>
                                    <input type="hidden" name="entry_date" value="{{ entry.entry_date }}">
                                    {% if not is_locked %}
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-save me-1"></i>Save
                                        </button>
                                    {% else %}
                                        <span class="text-muted">Locked</span>
                                    {% endif %}
                                </td>
                            </form>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pay Preview -->
    <div class="col-lg-4 mb-4">
        {% if pay_preview and employee %}

        {% if salary_type != 'Salary' %}
        <!-- Hours Breakdown -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-clock me-2"></i>Hours <span class="badge bg-light text-dark">${{ "%.2f"|format(employee.hourly_rate) }}/hr</span>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td>Regular:</td>
                            <td class="text-end">{{ "%.1f"|format(pay_preview.regular_hours) }}</td>
                        </tr>
                        <tr>
                            <td>Overtime (1.5x):</td>
                            <td class="text-end">{{ "%.1f"|format(pay_preview.overtime_hours) }}</td>
                        </tr>
                        <tr>
                            <td>Saturday (1.5x):</td>
                            <td class="text-end">{{ "%.1f"|format(pay_preview.saturday_hours) }}</td>
                        </tr>
                        <tr>
                            <td>PTO:</td>
                            <td class="text-end">{{ "%.1f"|format(pay_preview.pto_hours) }}</td>
                        </tr>
                        <tr class="fw-bold border-top">
                            <td>Total:</td>
                            <td class="text-end">{{ "%.1f"|format(pay_preview.total_hours) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Earnings -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <i class="bi bi-cash me-2"></i>Earnings
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td>Base Pay:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.base_pay) }}</td>
                        </tr>
                        {% if pay_preview.overtime_pay > 0 %}
                        <tr>
                            <td>Overtime:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.overtime_pay) }}</td>
                        </tr>
                        {% endif %}
                        {% if pay_preview.saturday_pay > 0 %}
                        <tr>
                            <td>Saturday:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.saturday_pay) }}</td>
                        </tr>
                        {% endif %}
                        {% if pay_preview.dependent_stipend > 0 %}
                        <tr>
                            <td>Dependent Stipend:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.dependent_stipend) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="fw-bold border-top">
                            <td>Gross Pay:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.gross_pay) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Deductions & Taxes Summary -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-dash-circle me-2"></i>Deductions & Taxes
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td>Medical:</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.medical_deduction) }}</td>
                        </tr>
                        <tr>
                            <td>Federal Tax:</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.federal_tax_employee) }}</td>
                        </tr>
                        <tr>
                            <td>State Tax (IN):</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.state_tax) }}</td>
                        </tr>
                        <tr>
                            <td>Social Security:</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.social_security_employee) }}</td>
                        </tr>
                        <tr>
                            <td>Medicare:</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.medicare_employee) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Net Pay -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-calculator me-2"></i>Estimated Pay <span class="badge bg-light text-dark">PREVIEW</span>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td class="text-start">Gross Pay:</td>
                            <td class="text-end">${{ "%.2f"|format(pay_preview.gross_pay) }}</td>
                        </tr>
                        <tr>
                            <td class="text-start">Total Deductions:</td>
                            <td class="text-end text-danger">-${{ "%.2f"|format(pay_preview.total_employee_deductions + pay_preview.total_employee_taxes) }}</td>
                        </tr>
                        <tr class="border-top border-2">
                            <td class="text-start fw-bold">Net Pay:</td>
                            <td class="text-end fw-bold text-success">${{ "%.2f"|format(pay_preview.net_pay) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <!-- No Employee Data -->
        <div class="card border-secondary">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-calculator me-2"></i>Pay Preview
            </div>
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle fs-1 text-muted"></i>
                <p class="text-muted mt-3 mb-0">Unable to load pay preview</p>
                <p class="text-muted small">Please refresh the page</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
